<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="https://i.pinimg.com/736x/54/3b/3f/543b3f40b72752d5d8d76fb0177d5a76.jpg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>prefix edit</title>

  <!-- JSZip (ZIP creation) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --fg:#f6f0f7;
      --muted:rgba(255,255,255,.68);
      --border:rgba(255,255,255,.12);
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.03);
      --shadow:0 18px 55px rgba(0,0,0,.55);
      --r:14px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";

      --pink1: rgba(255, 86, 168, .18);
      --pink2: rgba(255, 140, 215, .12);
      --pink3: rgba(210, 80, 255, .10);
      --btn: rgba(255, 120, 200, .22);
      --btnHover: rgba(255, 120, 200, .28);

      --bgDim: .35;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--fg);
      background:#08070a;
      overflow:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.80)),
        url("https://wallpapercave.com/wp/wp7789919.jpg");
      background-size:cover;
      background-position:center;
      filter: brightness(var(--bgDim)) saturate(1.05);
      transform: translateZ(0);
      z-index:-2;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(1200px 900px at 18% 12%, var(--pink1), transparent 58%),
        radial-gradient(900px 700px at 78% 26%, var(--pink2), transparent 62%),
        radial-gradient(1000px 800px at 55% 88%, var(--pink3), transparent 60%);
      z-index:-1;
      pointer-events:none;
    }

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:14px;
      gap:12px;
    }

    header{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    h1{margin:0;font-size:15px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;line-height:1.35}

    .grid{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .app{height:auto; min-height:100vh}
      .grid{grid-template-columns:1fr}
    }

    .card{
      min-height:0;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(0.5px);
    }

    .hd{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hd b{font-size:12.5px}

    .bd{padding:12px;overflow:auto;}
    .bd.preview{
      overflow:hidden !important;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    label{display:block;color:var(--muted);font-size:11.5px;margin-bottom:6px}
    input[type="text"], input[type="number"]{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.26);
      color:var(--fg);
      outline:none;
    }

    input[type="file"]{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:rgba(0,0,0,.22);
      color:var(--muted);
    }
    input[type="file"]::file-selector-button{
      background:#000;
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:7px 10px;
      margin-right:10px;
      cursor:pointer;
      font-weight:800;
    }
    input[type="file"]::file-selector-button:hover{border-color:rgba(255,255,255,.32);}

    .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:10px}
    .sep{height:1px;background:var(--border);margin:10px 0}

    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--fg);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      width:100%;
    }
    .btn:hover{background:var(--btnHover)}

    .tiny{margin-top:6px;font-size:11.2px;color:var(--muted);line-height:1.35}
    .status{margin-top:8px;font-size:11.5px;color:var(--muted)}
    .status b{color:var(--fg)}

    .previewSplit{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){ .previewSplit{grid-template-columns:1fr} }

    .pv{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.20);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .pvh{
      padding:9px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pvh .t{font-size:12px;font-weight:900}
    .pvh .s{font-size:11.2px;color:var(--muted)}

    .pvb{
      padding:10px 12px;
      overflow:hidden;
      flex:1;
      min-height:0;
      display:flex;
      align-items:flex-start;
    }

    .thumbs{
      width:100%;
      display:grid;
      gap:8px;
      align-content:start;
      justify-items:stretch;
    }
    .thumbs.score{grid-template-columns: repeat(7, minmax(0, 1fr));}
    .thumbs.combo{grid-template-columns: repeat(5, minmax(0, 1fr));}
    @media (max-width: 1160px){
      .thumbs.score{grid-template-columns: repeat(6, minmax(0, 1fr));}
      .thumbs.combo{grid-template-columns: repeat(5, minmax(0, 1fr));}
    }
    @media (max-width: 560px){
      .thumbs.score{grid-template-columns: repeat(5, minmax(0, 1fr));}
      .thumbs.combo{grid-template-columns: repeat(5, minmax(0, 1fr));}
    }

    .thumb{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:5px;
      padding:7px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.035);
      text-align:center;
    }
    .thumb canvas{display:block}
    .cap{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    .chk{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:12px;
    }
    .chk input{width:16px;height:16px}
    .chk span{font-size:11.6px;color:var(--muted);line-height:1.25}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>osu!mania — Score/Combo Archives (Font → PNG)</h1>
        <div class="sub"><span style="font-family:var(--mono)">preview</span></div>
      </div>
    </header>

    <div class="grid">
      <!-- SETTINGS -->
      <section class="card">
        <div class="hd">
          <b>Settings</b>
          <span class="tiny" style="margin:0">Score/Combo</span>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>Score prefix</label>
              <input id="scorePrefix" type="text" value="score-" />
            </div>
            <div>
              <label>Combo prefix</label>
              <input id="comboPrefix" type="text" value="mania-combo-" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>Scoreentry prefix</label>
              <input id="scoreEntryPrefix" type="text" value="scoreentry-" />
            </div>
            <div>
              <label>Scoreentry size (text px)</label>
              <input id="scoreEntrySize" type="number" min="1" step="1" value="20" />
              <div class="tiny">Image is always 21×28 (@2x).</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>Score font (.ttf/.otf)</label>
              <input id="scoreFont" type="file" accept=".ttf,.otf" />
            </div>
            <div>
              <label>Combo font (.ttf/.otf)</label>
              <input id="comboFont" type="file" accept=".ttf,.otf" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row3">
            <div>
              <label>Img Size</label>
              <div class="row" style="gap:8px">
                <input id="nW" type="number" min="1" step="1" value="44" />
                <input id="nH" type="number" min="1" step="1" value="66" />
              </div>
            </div>

            <div>
              <label>Extra: h-style</label>
              <input id="mySize" type="number" min="1" step="1" value="350" />
              <div class="tiny">Draw in top-right</div>
            </div>

            <div>
              <label>padding</label>
              <input id="myPad" type="number" min="0" step="1" value="6" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div>
              <label>Normal alignment</label>
              <div class="row" style="gap:8px">
                <div>
                  <label style="margin-bottom:6px">Global Y</label>
                  <input id="topY" type="number" step="1" value="0" />
                </div>
                <div>
                  <label style="margin-bottom:6px">Dot/Comma/X extra Y</label>
                  <input id="dotXExtraY" type="number" step="1" value="3" />
                </div>
              </div>
              <div class="tiny">All normal sets are true-vertically-centered by glyph bounds, then Y-shifted. My-style is untouched.</div>
            </div>

            <div>
              <label>Scoreentry transparency (optional)</label>
              <div class="row" style="gap:8px">
                <div class="chk">
                  <input id="entryTransparentPercent" type="checkbox" checked />
                  <span>Include transparent <b>%</b> (scoreentry-percent)</span>
                </div>
                <div class="chk">
                  <input id="entryTransparentX" type="checkbox" />
                  <span>Make <b>x</b> transparent</span>
                </div>
              </div>
              <div class="tiny">Scoreentry base: 0–9, dot, comma, x.</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div>
              <label>Score: normal size / color</label>
              <div class="row" style="gap:8px">
                <input id="scoreSize" type="number" min="1" step="1" value="52" />
                <input id="scoreColor" type="text" value="#FFFFFF" />
              </div>
              <div class="row" style="gap:8px;margin-top:8px">
                <input id="scoreOffX" type="number" step="1" value="0" />
                <input id="scoreOffY" type="number" step="1" value="0" />
              </div>
              <div class="tiny">Offsets: X then Y.</div>
            </div>

            <div>
              <label>Combo: normal size / color</label>
              <div class="row" style="gap:8px">
                <input id="comboSize" type="number" min="1" step="1" value="52" />
                <input id="comboColor" type="text" value="#FFFFFF" />
              </div>
              <div class="row" style="gap:8px;margin-top:8px">
                <input id="comboOffX" type="number" step="1" value="0" />
                <input id="comboOffY" type="number" step="1" value="0" />
              </div>
              <div class="tiny">Offsets: X then Y.</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div>
              <label>My-style score size</label>
              <input id="myScoreSize" type="number" min="1" step="1" value="34" />
              <div class="tiny">Only affects my-style score.</div>
            </div>
            <div>
              <label>My-style uses</label>
              <input type="text" value="Score only (no combo)" readonly />
              <div class="tiny">my-style exports only score folder.</div>
            </div>
          </div>

          <div class="sep"></div>

          <button id="btnDownload" class="btn">Download Archives</button>
          <div class="status" id="status">Status: <b>ready</b>.</div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section class="card">
        <div class="hd"><b>Preview</b></div>
        <div class="bd preview">
          <div class="previewSplit">
            <div class="pv">
              <div class="pvh">
                <div>
                  <div class="t">Score preview</div>
                  <div class="s" id="infoScore">—</div>
                </div>
                <div class="s" id="tagScore">Normal preview</div>
              </div>
              <div class="pvb"><div class="thumbs score" id="pvScore"></div></div>
            </div>

            <div class="pv">
              <div class="pvh">
                <div>
                  <div class="t">Combo</div>
                  <div class="s" id="infoCombo">—</div>
                </div>
                <div class="s" id="tagCombo">Normal preview</div>
              </div>
              <div class="pvb"><div class="thumbs combo" id="pvCombo"></div></div>
            </div>
          </div>

          <div class="tiny" style="margin-top:0">
            Preview always shows the <span style="font-family:var(--mono)">img @2x</span> set only.
            (ZIP includes <span style="font-family:var(--mono)">normal 1x</span>, <span style="font-family:var(--mono)">my-style</span> and <span style="font-family:var(--mono)">scoreentry</span>.)
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const SCORE_GLYPHS = ['1','2','3','4','5','6','7','8','9','0','.', '%', 'x', ','];
  const COMBO_GLYPHS = ['1','2','3','4','5','6','7','8','9','0'];

  // scoreentry: includes comma too (comma uses DOT artwork)
  const SCOREENTRY_BASE = ['1','2','3','4','5','6','7','8','9','0','.', ',', 'x'];

  const scoreKeyForGlyph = (g) => {
    if (g >= '0' && g <= '9') return g;
    if (g === '.') return 'dot';
    if (g === '%') return 'percent';
    if (g === 'x') return 'x';
    if (g === ',') return 'comma';
    return g;
  };

  // score-comma uses dot artwork; comma filename stays "comma"
  const scoreDrawCharForKey = (key, originalGlyph) => (key === 'comma' ? '.' : originalGlyph);

  const el = {
    scorePrefix: $('scorePrefix'),
    comboPrefix: $('comboPrefix'),
    scoreEntryPrefix: $('scoreEntryPrefix'),

    scoreFont: $('scoreFont'),
    comboFont: $('comboFont'),

    nW: $('nW'),
    nH: $('nH'),
    mySize: $('mySize'),
    myPad: $('myPad'),

    topY: $('topY'),
    dotXExtraY: $('dotXExtraY'),

    scoreSize: $('scoreSize'),
    scoreColor: $('scoreColor'),
    scoreOffX: $('scoreOffX'),
    scoreOffY: $('scoreOffY'),

    comboSize: $('comboSize'),
    comboColor: $('comboColor'),
    comboOffX: $('comboOffX'),
    comboOffY: $('comboOffY'),

    myScoreSize: $('myScoreSize'),

    scoreEntrySize: $('scoreEntrySize'),
    entryTransparentPercent: $('entryTransparentPercent'),
    entryTransparentX: $('entryTransparentX'),

    btnDownload: $('btnDownload'),
    status: $('status'),

    pvScore: $('pvScore'),
    pvCombo: $('pvCombo'),
    infoScore: $('infoScore'),
    infoCombo: $('infoCombo'),
    tagScore: $('tagScore'),
    tagCombo: $('tagCombo'),
  };

  let fontScore = 'sans-serif';
  let fontCombo = 'sans-serif';

  const makeCanvas = (w,h) => { const c=document.createElement('canvas'); c.width=w; c.height=h; return c; };
  const setStatus = (t) => el.status.innerHTML = `Status: <b>${t}</b>.`;
  const sanitizePrefix = (p) => (p||'').trim();

  async function loadFontFromFile(file, base){
    if(!file) return 'sans-serif';
    const ab = await file.arrayBuffer();
    const blob = new Blob([ab], {type:"font/ttf"});
    const url = URL.createObjectURL(blob);
    const family = `${base}-${Math.random().toString(16).slice(2)}`;
    const ff = new FontFace(family, `url(${url})`);
    await ff.load();
    document.fonts.add(ff);
    return family;
  }

  function clear(ctx,w,h){ ctx.clearRect(0,0,w,h); }

  // FIX: proper vertical centering using glyph bounds (measureText),
  // then apply a global Y shift + an extra drop for dot/comma/x.
  function drawBBoxCentered(ctx, text, w, h, family, size, color, ox, oy, globalY, extraY){
    ctx.save();
    ctx.font = `${size}px "${family}", sans-serif`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';
    ctx.imageSmoothingEnabled = true;

    const m = ctx.measureText(text);
    const asc = m.actualBoundingBoxAscent ?? size * 0.8;
    const desc = m.actualBoundingBoxDescent ?? size * 0.2;

    // baseline so that (top..bottom) of glyph bbox is centered in canvas
    const baseline = (h - (asc + desc)) / 2 + asc;

    ctx.fillText(text, w/2 + ox, baseline + oy + globalY + extraY);
    ctx.restore();
  }

  function drawTopRight(ctx, text, w, h, family, size, color, pad, ox, oy){
    ctx.save();
    ctx.font = `${size}px "${family}", sans-serif`;
    ctx.fillStyle = color;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';
    ctx.imageSmoothingEnabled = true;

    const m = ctx.measureText(text);
    const asc = m.actualBoundingBoxAscent || size*0.8;
    const desc = m.actualBoundingBoxDescent || size*0.2;
    const tw = m.width;

    let x = (w - pad - tw) + ox;
    let y = (pad + asc) + oy;

    x = Math.max(0, Math.min(x, w - tw));
    y = Math.max(asc, Math.min(y, h - desc));

    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function downscale(src, w, h){
    const out = makeCanvas(w,h);
    const o = out.getContext('2d');
    o.imageSmoothingEnabled = true;
    o.clearRect(0,0,w,h);
    o.drawImage(src, 0,0,w,h);
    return out;
  }

  const canvasToBlob = (c) => new Promise(res => c.toBlob(res,'image/png'));

  function fillPreview(container, map){
    container.innerHTML = '';
    for(const [name, canvas] of map.entries()){
      const box = document.createElement('div');
      box.className = 'thumb';

      const c = makeCanvas(canvas.width, canvas.height);
      c.getContext('2d').drawImage(canvas,0,0);
      box.appendChild(c);

      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = name;
      box.appendChild(cap);

      container.appendChild(box);
    }
  }

  function renderNormalAndMy({
    prefix, family,
    normalTextSize, myTextSize,
    color, ox, oy,
    globalY, dotXExtraY,
    nW, nH, mySize, myPad,
    glyphs, keyForGlyph,
    normalDrawCharForKey,
    normalOverrides,
    myOverrides
  }){
    const pref = sanitizePrefix(prefix);

    const normal2x = new Map();
    const normal1x = new Map();
    const my = new Map();

    for(const g of glyphs){
      const key = keyForGlyph ? keyForGlyph(g) : g;

      // dot/x extra drop (comma draws dot too)
      const extra = (key === 'dot' || key === 'x' || key === 'comma') ? dotXExtraY : 0;

      // normal
      const nOv = normalOverrides?.[key] || null;
      if(nOv?.type === 'empty'){
        const c2e = makeCanvas(nW,nH);
        const c1e = makeCanvas(Math.max(1, Math.round(nW/2)), Math.max(1, Math.round(nH/2)));
        normal2x.set(`${pref}${key}@2x.png`, c2e);
        normal1x.set(`${pref}${key}.png`, c1e);
      } else {
        const c2 = makeCanvas(nW,nH);
        const ctx2 = c2.getContext('2d');
        clear(ctx2,nW,nH);

        const drawChar = normalDrawCharForKey ? normalDrawCharForKey(key, g) : g;
        drawBBoxCentered(ctx2, drawChar, nW,nH, family, normalTextSize, color, ox, oy, globalY, extra);

        const c1 = downscale(c2, Math.max(1, Math.round(nW/2)), Math.max(1, Math.round(nH/2)));
        normal2x.set(`${pref}${key}@2x.png`, c2);
        normal1x.set(`${pref}${key}.png`, c1);
      }

      // my-style
      const ov = myOverrides?.[key] || null;
      if(ov?.type === 'empty'){
        const ce = makeCanvas(ov.w, ov.h);
        my.set(`${pref}${key}.png`, ce);
      } else {
        const S = mySize;
        const cm = makeCanvas(S,S);
        const ctxm = cm.getContext('2d');
        clear(ctxm,S,S);
        const drawChar = normalDrawCharForKey ? normalDrawCharForKey(key, g) : g;
        drawTopRight(ctxm, drawChar, S,S, family, myTextSize, color, myPad, ox, oy);
        my.set(`${pref}${key}.png`, cm);
      }
    }

    return { normal2x, normal1x, my };
  }

  function renderEntry({
    prefix, family,
    textSize, color, ox, oy,
    globalY, dotXExtraY,
    includeTransparentPercent,
    transparentX
  }){
    const pref = sanitizePrefix(prefix);

    const W2 = 21, H2 = 28;
    const W1 = Math.max(1, Math.round(W2/2)); // 11
    const H1 = Math.max(1, Math.round(H2/2)); // 14

    const glyphs = [...SCOREENTRY_BASE];
    if(includeTransparentPercent) glyphs.push('%');

    const normal2x = new Map();
    const normal1x = new Map();

    for(const g of glyphs){
      const key = scoreKeyForGlyph(g);
      const extra = (key === 'dot' || key === 'x' || key === 'comma') ? dotXExtraY : 0;

      // scoreentry-comma MUST be dot artwork (draw ".")
      const drawChar = (key === 'comma') ? '.' : g;

      const makeEmpty = (g === '%') || (transparentX && g === 'x');
      if(makeEmpty){
        normal2x.set(`${pref}${key}@2x.png`, makeCanvas(W2,H2));
        normal1x.set(`${pref}${key}.png`, makeCanvas(W1,H1));
        continue;
      }

      const c2 = makeCanvas(W2,H2);
      const ctx2 = c2.getContext('2d');
      clear(ctx2,W2,H2);

      drawBBoxCentered(ctx2, drawChar, W2,H2, family, textSize, color, ox, oy, globalY, extra);

      const c1 = downscale(c2, W1, H1);
      normal2x.set(`${pref}${key}@2x.png`, c2);
      normal1x.set(`${pref}${key}.png`, c1);
    }

    return { normal2x, normal1x };
  }

  async function ensureFonts(){
    setStatus('loading fonts');
    fontScore = await loadFontFromFile(el.scoreFont.files?.[0] || null, 'ScoreFont');
    fontCombo = await loadFontFromFile(el.comboFont.files?.[0] || null, 'ComboFont');
    setStatus('fonts ready');
  }

  function renderPreview(){
    const nW = Math.max(1, parseInt(el.nW.value||'44',10));
    const nH = Math.max(1, parseInt(el.nH.value||'66',10));
    const mySize = Math.max(1, parseInt(el.mySize.value||'350',10));
    const myPad = Math.max(0, parseInt(el.myPad.value||'6',10));

    const globalY = parseInt(el.topY.value||'0',10);
    const dotXExtraY = parseInt(el.dotXExtraY.value||'3',10);

    const score = renderNormalAndMy({
      prefix: el.scorePrefix.value,
      family: fontScore,
      normalTextSize: parseInt(el.scoreSize.value||'52',10),
      myTextSize: parseInt(el.myScoreSize.value||'34',10),
      color: (el.scoreColor.value||'#fff').trim(),
      ox: parseInt(el.scoreOffX.value||'0',10),
      oy: parseInt(el.scoreOffY.value||'0',10),
      globalY, dotXExtraY,
      nW, nH, mySize, myPad,
      glyphs: SCORE_GLYPHS,
      keyForGlyph: scoreKeyForGlyph,
      normalDrawCharForKey: scoreDrawCharForKey,
      myOverrides: {
        percent: { type:'empty', w:1000, h:1 } // my-style score-percent empty 1000x1
      }
    });

    const combo = renderNormalAndMy({
      prefix: el.comboPrefix.value,
      family: fontCombo,
      normalTextSize: parseInt(el.comboSize.value||'52',10),
      myTextSize: parseInt(el.comboSize.value||'52',10),
      color: (el.comboColor.value||'#fff').trim(),
      ox: parseInt(el.comboOffX.value||'0',10),
      oy: parseInt(el.comboOffY.value||'0',10),
      globalY, dotXExtraY,
      nW, nH, mySize, myPad,
      glyphs: COMBO_GLYPHS
    });

    fillPreview(el.pvScore, score.normal2x);
    fillPreview(el.pvCombo, combo.normal2x);

    el.infoScore.textContent = `${nW}×${nH} • bbox-centered • dot/comma/x extraY`;
    el.infoCombo.textContent = `${nW}×${nH} • bbox-centered`;
    el.tagScore.textContent = 'Normal @2x';
    el.tagCombo.textContent = 'Normal @2x';

    return {score, combo};
  }

  async function downloadArchives(){
    try{
      if(!window.JSZip){
        setStatus('JSZip missing (CDN blocked)');
        return;
      }

      await ensureFonts();
      setStatus('rendering');

      const nW = Math.max(1, parseInt(el.nW.value||'44',10));
      const nH = Math.max(1, parseInt(el.nH.value||'66',10));
      const mySize = Math.max(1, parseInt(el.mySize.value||'350',10));
      const myPad = Math.max(0, parseInt(el.myPad.value||'6',10));

      const globalY = parseInt(el.topY.value||'0',10);
      const dotXExtraY = parseInt(el.dotXExtraY.value||'3',10);

      const score = renderNormalAndMy({
        prefix: el.scorePrefix.value,
        family: fontScore,
        normalTextSize: parseInt(el.scoreSize.value||'52',10),
        myTextSize: parseInt(el.myScoreSize.value||'34',10),
        color: (el.scoreColor.value||'#fff').trim(),
        ox: parseInt(el.scoreOffX.value||'0',10),
        oy: parseInt(el.scoreOffY.value||'0',10),
        globalY, dotXExtraY,
        nW, nH, mySize, myPad,
        glyphs: SCORE_GLYPHS,
        keyForGlyph: scoreKeyForGlyph,
        normalDrawCharForKey: scoreDrawCharForKey,
        myOverrides: {
          percent: { type:'empty', w:1000, h:1 }
        }
      });

      const combo = renderNormalAndMy({
        prefix: el.comboPrefix.value,
        family: fontCombo,
        normalTextSize: parseInt(el.comboSize.value||'52',10),
        myTextSize: parseInt(el.comboSize.value||'52',10),
        color: (el.comboColor.value||'#fff').trim(),
        ox: parseInt(el.comboOffX.value||'0',10),
        oy: parseInt(el.comboOffY.value||'0',10),
        globalY, dotXExtraY,
        nW, nH, mySize, myPad,
        glyphs: COMBO_GLYPHS
      });

      const entry = renderEntry({
        prefix: el.scoreEntryPrefix.value,
        family: fontScore,
        textSize: parseInt(el.scoreEntrySize.value||'20',10),
        color: (el.scoreColor.value||'#fff').trim(),
        ox: parseInt(el.scoreOffX.value||'0',10),
        oy: parseInt(el.scoreOffY.value||'0',10),
        globalY, dotXExtraY,
        includeTransparentPercent: !!el.entryTransparentPercent.checked,
        transparentX: !!el.entryTransparentX.checked
      });

      const zip = new JSZip();
      const normal = zip.folder('normal');

      for(const [name, canvas] of score.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of score.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of combo.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of combo.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of entry.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of entry.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));

      const my = zip.folder('my-style');
      const myScore = my.folder('score');
      for(const [name, canvas] of score.my.entries()) myScore.file(name, await canvasToBlob(canvas));

      setStatus('zipping');

      const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'osu-archives.zip';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 2000);
      setStatus('done');
    }catch(e){
      console.error(e);
      setStatus('error (check console)');
    }
  }

  let debounceT = null;
  function schedulePreview(){
    clearTimeout(debounceT);
    debounceT = setTimeout(async () => {
      try{
        await ensureFonts();
        renderPreview();
        setStatus('preview updated');
      }catch(e){
        console.error(e);
        setStatus('error (check console)');
      }
    }, 160);
  }

  el.btnDownload.addEventListener('click', downloadArchives);

  const watch = [
    'scorePrefix','comboPrefix','scoreEntryPrefix',
    'scoreFont','comboFont',
    'nW','nH','mySize','myPad',
    'topY','dotXExtraY',
    'scoreSize','scoreColor','scoreOffX','scoreOffY',
    'comboSize','comboColor','comboOffX','comboOffY',
    'myScoreSize','scoreEntrySize'
  ];
  watch.forEach(id => $(id).addEventListener('input', schedulePreview));
  $('scoreFont').addEventListener('change', schedulePreview);
  $('comboFont').addEventListener('change', schedulePreview);
  $('entryTransparentPercent').addEventListener('change', schedulePreview);
  $('entryTransparentX').addEventListener('change', schedulePreview);

  (async () => {
    try{
      await ensureFonts();
      renderPreview();
      setStatus('ready');
    }catch(e){
      setStatus('ready');
    }
  })();
})();
</script>
</body>
</html>
