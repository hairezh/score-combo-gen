<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="https://i.pinimg.com/736x/54/3b/3f/543b3f40b72752d5d8d76fb0177d5a76.jpg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>prefix edit</title>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --fg:#e9e9ee;
      --muted:rgba(233,233,238,.62);
      --muted2:rgba(233,233,238,.40);
      --border:rgba(255,255,255,.12);
      --panel:rgba(0,0,0,.44);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:14px;

      --dockW:62px;
      --gap:10px;

      --rowLabel: 205px;
      --inputPadY: 9px;
      --inputPadX: 10px;

      color-scheme: dark;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--fg);
      font: 14px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;

      background-image: url("https://i.pinimg.com/originals/f5/93/a4/f593a4f4932080fb7b43c6ae96d1a73d.gif");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      overflow:hidden;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(0,0,0,.16), transparent 55%),
        radial-gradient(900px 520px at 85% 20%, rgba(0,0,0,.16), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.58), rgba(0,0,0,.56));
      backdrop-filter: blur(0.6px);
    }

    /* Scrollbar */
    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(220,220,230,.30) rgba(0,0,0,.20);
    }
    *::-webkit-scrollbar{ width:10px; height:10px; }
    *::-webkit-scrollbar-track{ background: rgba(0,0,0,.20); border-radius: 10px; }
    *::-webkit-scrollbar-thumb{
      background: rgba(220,220,230,.26);
      border: 2px solid rgba(0,0,0,.20);
      border-radius: 10px;
    }
    *::-webkit-scrollbar-thumb:hover{ background: rgba(220,220,230,.40); }

    .app{
      position:relative;
      z-index:1;
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(3px);
      will-change: transform;
      transform: translateZ(0);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand img{
      width:30px;
      height:30px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      object-fit: cover;
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand .title b{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .title span{
      font-size:12px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.75);
      font-weight:900;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .btn{
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.78);
      font-weight:900;
      transition:110ms linear;
      user-select:none;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(233,233,238,.95);
    }
    .btn.primary{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: rgba(233,233,238,.95);
    }

    .layout{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: var(--dockW) 1fr;
      overflow:hidden;
    }

    /* ===== Sidebar dock ===== */
    .dock{
      border-right:1px solid var(--border);
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(3px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:10px 8px;
      min-height:0;
      overflow:auto;
      will-change: transform;
      transform: translateZ(0);
    }

    .dockGroup{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .dockGroup:last-child{ border-bottom:0; padding-bottom:0; }

    .icoBtn{
      width:46px;
      height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.78);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition:110ms linear;
      position:relative;
      will-change: transform;
      transform: translateZ(0);
    }
    .icoBtn:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(233,233,238,.95);
      transform: translateY(-1px) translateZ(0);
    }
    .icoBtn.active{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: rgba(233,233,238,.98);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .tip{
      position:absolute;
      left:58px;
      top:50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:6px 10px;
      font-size:12px;
      color: rgba(233,233,238,.92);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:110ms linear;
      backdrop-filter: blur(3px);
    }
    .icoBtn:hover .tip{ opacity:1; }

    .miniLabel{
      font-size:11px;
      color: var(--muted2);
      text-align:center;
      line-height:1.2;
    }

    /* ===== Main ===== */
    .main{
      min-height:0;
      padding:10px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:10px;
      overflow:hidden;
      align-items:stretch;
    }

    .card{
      border:1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(3px);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      will-change: transform;
      transform: translateZ(0);
    }

    .cardHead{
      padding:10px 10px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(4px);
    }

    .cardBody{
      padding:10px;
      overflow:auto;
      min-height:0;
      flex:1;
    }

    /* ===== Form pieces ===== */
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; }

    label{
      display:block;
      font-size:12px;
      color: rgba(233,233,238,.80);
      font-weight:900;
      user-select:none;
      margin-bottom:6px;
    }

    input[type="text"], input[type="number"]{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(0,0,0,.26);
      color: rgba(233,233,238,.95);
      padding: var(--inputPadY) var(--inputPadX);
      outline:none;
      font:inherit;
    }

    input[type="file"]{
      width:100%;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.70);
      padding: var(--inputPadY) var(--inputPadX);
      outline:none;
      font:inherit;
    }
    input[type="file"]::file-selector-button{
      background: rgba(255,255,255,.10);
      color: rgba(233,233,238,.95);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:7px 10px;
      margin-right:10px;
      cursor:pointer;
      font-weight:900;
    }
    input[type="file"]::file-selector-button:hover{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.14);
    }

    .chk{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:12px;
    }
    .chk input{ width:16px; height:16px; }
    .chk span{ font-size:12px; color: rgba(233,233,238,.70); font-weight:900; }

    .statusLine{
      margin-top:8px;
      font-size:12px;
      color: rgba(233,233,238,.70);
      font-weight:900;
    }
    .statusLine b{ color: rgba(233,233,238,.95); }

    /* ===== Preview panes ===== */
    .previewSplit{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height:0;
      height: 100%;
    }

    .pv{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .pvh{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.18);
    }
    .pvh .t{ font-size:12px; font-weight:900; color: rgba(233,233,238,.95); }
    .pvh .s{ font-size:12px; color: rgba(233,233,238,.62); font-weight:900; }

    .pvb{
      padding:10px;
      overflow:auto;
      flex:1;
      min-height:0;
    }

    .thumbs{
      width:100%;
      display:grid;
      gap:8px;
      align-content:start;
      justify-items:stretch;
    }
    .thumbs.score{ grid-template-columns: repeat(7, minmax(0, 1fr)); }
    .thumbs.combo{ grid-template-columns: repeat(5, minmax(0, 1fr)); }

    .thumb{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:5px;
      padding:7px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.035);
      text-align:center;
    }
    .thumb canvas{ display:block; max-width:100%; height:auto; }
    .cap{
      font-size:10px;
      color: rgba(233,233,238,.62);
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color: rgba(233,233,238,.50);
      font-weight:900;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .layout{ grid-template-columns: 1fr; }
      .dock{
        flex-direction:row;
        border-right:0;
        border-bottom:1px solid var(--border);
        padding:10px;
        gap:10px;
      }
      .dockGroup{
        flex-direction:row;
        border-bottom:0;
        padding-bottom:0;
        width:auto;
      }
      .icoBtn .tip{ display:none; }
      .main{ grid-template-columns: 1fr; }
      .previewSplit{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOPBAR (igual do primeiro) -->
    <div class="topbar">
      <div class="brand">
        <img alt="icon" src="https://i.pinimg.com/originals/da/b4/cb/dab4cbf31e4e8d7688b0e830d5d640f1.gif">
        <div class="title">
          <b>prefix edit</b>
          <span>osu!mania ‚Äî prefixes</span>
        </div>
      </div>

      <div class="tools">
        <span class="badge" id="status">Status: <b>ready</b>.</span>
        <button class="btn primary" id="btnDownload" type="button">Download Archives</button>
      </div>
    </div>

    <div class="layout">
      <!-- DOCK (visual do primeiro) -->
      <aside class="dock">
        <div class="dockGroup">
          <button class="icoBtn active" type="button" title="Settings">
            <span aria-hidden="true">‚öôÔ∏è</span>
            <span class="tip">Settings</span>
          </button>

          <button class="icoBtn" type="button" title="Preview" onclick="document.getElementById('previewCard')?.scrollIntoView({behavior:'smooth', block:'start'})">
            <span aria-hidden="true">üëÅÔ∏è</span>
            <span class="tip">Preview</span>
          </button>
        </div>

        <div class="dockGroup">
          <div class="miniLabel">tools</div>
          <button class="icoBtn" type="button" title="Update preview" id="forcePreviewBtn">
            <span aria-hidden="true">‚Üª</span>
            <span class="tip">Update preview</span>
          </button>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">

        <!-- SETTINGS CARD -->
        <section class="card" id="settingsCard">
          <div class="cardHead">
            <div class="tools">
              <span class="badge">Settings</span>
            </div>
            <div class="tools">
              <button class="btn" type="button" id="miniUpdateBtn">Refresh</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="row2">
              <div>
                <label>Score prefix</label>
                <input id="scorePrefix" type="text" value="score-" />
              </div>
              <div>
                <label>Combo prefix</label>
                <input id="comboPrefix" type="text" value="mania-combo-" />
              </div>
            </div>

            <div class="row2" style="margin-top:10px;">
              <div>
                <label>Scoreentry prefix</label>
                <input id="scoreEntryPrefix" type="text" value="scoreentry-" />
              </div>
              <div>
                <label>Scoreentry size</label>
                <input id="scoreEntrySize" type="number" min="1" step="1" value="20" />
              </div>
            </div>

            <div class="row2" style="margin-top:10px;">
              <div>
                <label>Score font</label>
                <input id="scoreFont" type="file" accept=".ttf,.otf" />
              </div>
              <div>
                <label>Combo font</label>
                <input id="comboFont" type="file" accept=".ttf,.otf" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="row2">
              <div>
                <label>Img size (score/combo)</label>
                <div class="row2" style="gap:8px">
                  <input id="nW" type="number" min="1" step="1" value="44" />
                  <input id="nH" type="number" min="1" step="1" value="66" />
                </div>
              </div>
              <div>
                <label>Dot/Comma/X tweak</label>
                <div class="row2" style="gap:8px">
                  <input id="dotXExtraY" type="number" step="1" value="3" />
                  <input id="centerBias" type="number" step="0.01" value="1.00" />
                </div>
                <div class="hint">extraY ‚Ä¢ bias</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row2">
              <div>
                <label>Score size / color</label>
                <div class="row2" style="gap:8px">
                  <input id="scoreSize" type="number" min="1" step="1" value="52" />
                  <input id="scoreColor" type="text" value="#FFFFFF" />
                </div>
              </div>

              <div>
                <label>Combo size / color</label>
                <div class="row2" style="gap:8px">
                  <input id="comboSize" type="number" min="1" step="1" value="52" />
                  <input id="comboColor" type="text" value="#FFFFFF" />
                </div>
              </div>
            </div>

            <div class="row2" style="margin-top:10px;">
              <div class="chk">
                <input id="entryTransparentPercent" type="checkbox" checked />
                <span>scoreentry-percent (transparent)</span>
              </div>
              <div class="chk">
                <input id="entryTransparentX" type="checkbox" />
                <span>scoreentry-x (transparent)</span>
              </div>
            </div>

            <div class="sep"></div>

            <div class="statusLine" id="statusMirror">
              Status: <b>ready</b>.
            </div>
          </div>
        </section>

        <!-- PREVIEW CARD -->
        <section class="card" id="previewCard">
          <div class="cardHead">
            <div class="tools">
              <span class="badge">Preview (@2x)</span>
            </div>
            <div class="tools">
              <span class="badge" id="infoScore">‚Äî</span>
              <span class="badge" id="infoCombo">‚Äî</span>
            </div>
          </div>

          <div class="cardBody" style="display:flex; flex-direction:column; gap:10px; min-height:0;">
            <div class="previewSplit">
              <div class="pv">
                <div class="pvh">
                  <div class="t">Score</div>
                  <div class="s" id="infoScore2">‚Äî</div>
                </div>
                <div class="pvb"><div class="thumbs score" id="pvScore"></div></div>
              </div>

              <div class="pv">
                <div class="pvh">
                  <div class="t">Combo</div>
                  <div class="s" id="infoCombo2">‚Äî</div>
                </div>
                <div class="pvb"><div class="thumbs combo" id="pvCombo"></div></div>
              </div>
            </div>

            <div class="hint">ZIP includes normal 1x + scoreentry (21√ó28 @2x).</div>
          </div>
        </section>

      </main>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const SCORE_GLYPHS = ['1','2','3','4','5','6','7','8','9','0','.', '%', 'x', ','];
  const COMBO_GLYPHS = ['1','2','3','4','5','6','7','8','9','0'];

  // scoreentry includes comma, and comma must be DOT artwork
  const SCOREENTRY_BASE = ['1','2','3','4','5','6','7','8','9','0','.', ',', 'x'];

  const scoreKeyForGlyph = (g) => {
    if (g >= '0' && g <= '9') return g;
    if (g === '.') return 'dot';
    if (g === '%') return 'percent';
    if (g === 'x') return 'x';
    if (g === ',') return 'comma';
    return g;
  };

  // comma uses dot artwork but keeps filename "comma"
  const drawCharForKey = (key, originalGlyph) => (key === 'comma' ? '.' : originalGlyph);

  const el = {
    scorePrefix: $('scorePrefix'),
    comboPrefix: $('comboPrefix'),
    scoreEntryPrefix: $('scoreEntryPrefix'),

    scoreFont: $('scoreFont'),
    comboFont: $('comboFont'),

    nW: $('nW'),
    nH: $('nH'),

    dotXExtraY: $('dotXExtraY'),
    centerBias: $('centerBias'),

    scoreSize: $('scoreSize'),
    scoreColor: $('scoreColor'),

    comboSize: $('comboSize'),
    comboColor: $('comboColor'),

    scoreEntrySize: $('scoreEntrySize'),
    entryTransparentPercent: $('entryTransparentPercent'),
    entryTransparentX: $('entryTransparentX'),

    btnDownload: $('btnDownload'),
    status: $('status'),

    pvScore: $('pvScore'),
    pvCombo: $('pvCombo'),
    infoScore: $('infoScore'),
    infoCombo: $('infoCombo'),

    // extra mirrors for the new layout
    statusMirror: $('statusMirror'),
    infoScore2: $('infoScore2'),
    infoCombo2: $('infoCombo2'),
    miniUpdateBtn: $('miniUpdateBtn'),
    forcePreviewBtn: $('forcePreviewBtn'),
  };

  let fontScore = 'sans-serif';
  let fontCombo = 'sans-serif';

  const makeCanvas = (w,h) => { const c=document.createElement('canvas'); c.width=w; c.height=h; return c; };
  const setStatus = (t) => {
    const html = `Status: <b>${t}</b>.`;
    if(el.status) el.status.innerHTML = html;
    if(el.statusMirror) el.statusMirror.innerHTML = html;
  };
  const sanitizePrefix = (p) => (p||'').trim();

  async function loadFontFromFile(file, base){
    if(!file) return 'sans-serif';
    const ab = await file.arrayBuffer();
    const blob = new Blob([ab], {type:"font/ttf"});
    const url = URL.createObjectURL(blob);
    const family = `${base}-${Math.random().toString(16).slice(2)}`;
    const ff = new FontFace(family, `url(${url})`);
    await ff.load();
    document.fonts.add(ff);
    return family;
  }

  const canvasToBlob = (c) => new Promise(res => c.toBlob(res,'image/png'));

  function clear(ctx,w,h){ ctx.clearRect(0,0,w,h); }

  // robust bbox centering
  function drawBBoxCentered(ctx, text, w, h, family, size, color, extraY, centerBias){
    ctx.save();
    ctx.font = `${size}px "${family}", sans-serif`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';

    const m = ctx.measureText(text);
    const asc = (m.actualBoundingBoxAscent ?? size*0.8);
    const desc = (m.actualBoundingBoxDescent ?? size*0.2);

    let baseline = (h - (asc + desc)) / 2 + asc;
    baseline = (h/2) + (baseline - h/2) * centerBias;

    ctx.fillText(text, w/2, baseline + extraY);
    ctx.restore();
  }

  function downscale(src, w, h){
    const out = makeCanvas(w,h);
    const o = out.getContext('2d');
    o.imageSmoothingEnabled = true;
    o.clearRect(0,0,w,h);
    o.drawImage(src, 0,0,w,h);
    return out;
  }

  function fillPreview(container, map){
    container.innerHTML = '';
    for(const [name, canvas] of map.entries()){
      const box = document.createElement('div');
      box.className = 'thumb';

      const c = makeCanvas(canvas.width, canvas.height);
      c.getContext('2d').drawImage(canvas,0,0);
      box.appendChild(c);

      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = name;
      box.appendChild(cap);

      container.appendChild(box);
    }
  }

  function renderNormal({prefix, family, size, color, nW, nH, glyphs, keyForGlyph, dotXExtraY, centerBias}){
    const pref = sanitizePrefix(prefix);

    const normal2x = new Map();
    const normal1x = new Map();

    for(const g of glyphs){
      const key = keyForGlyph ? keyForGlyph(g) : g;

      const isDotLike = (key === 'dot' || key === 'comma' || key === 'x');
      const extra = isDotLike ? dotXExtraY : 0;

      const c2 = makeCanvas(nW,nH);
      const ctx2 = c2.getContext('2d');
      clear(ctx2,nW,nH);

      const drawChar = drawCharForKey(key, g);
      drawBBoxCentered(ctx2, drawChar, nW, nH, family, size, color, extra, isDotLike ? centerBias : 1.0);

      const c1 = downscale(c2, Math.max(1, Math.round(nW/2)), Math.max(1, Math.round(nH/2)));

      normal2x.set(`${pref}${key}@2x.png`, c2);
      normal1x.set(`${pref}${key}.png`, c1);
    }

    return { normal2x, normal1x };
  }

  function renderScoreEntry({prefix, family, size, color, includeTransparentPercent, transparentX, dotXExtraY, centerBias}){
    const pref = sanitizePrefix(prefix);

    const W2 = 21, H2 = 28;
    const W1 = Math.max(1, Math.round(W2/2));
    const H1 = Math.max(1, Math.round(H2/2));

    const glyphs = [...SCOREENTRY_BASE];
    if(includeTransparentPercent) glyphs.push('%');

    const normal2x = new Map();
    const normal1x = new Map();

    for(const g of glyphs){
      const key = scoreKeyForGlyph(g);
      const isDotLike = (key === 'dot' || key === 'comma' || key === 'x');
      const extra = isDotLike ? dotXExtraY : 0;

      const makeEmpty = (g === '%') || (transparentX && g === 'x');
      if(makeEmpty){
        normal2x.set(`${pref}${key}@2x.png`, makeCanvas(W2,H2));
        normal1x.set(`${pref}${key}.png`, makeCanvas(W1,H1));
        continue;
      }

      const c2 = makeCanvas(W2,H2);
      const ctx2 = c2.getContext('2d');
      clear(ctx2,W2,H2);

      const drawChar = (key === 'comma') ? '.' : g;
      drawBBoxCentered(ctx2, drawChar, W2, H2, family, size, color, extra, isDotLike ? centerBias : 1.0);

      const c1 = downscale(c2, W1, H1);
      normal2x.set(`${pref}${key}@2x.png`, c2);
      normal1x.set(`${pref}${key}.png`, c1);
    }

    return { normal2x, normal1x };
  }

  async function ensureFonts(){
    setStatus('loading fonts');
    fontScore = await loadFontFromFile(el.scoreFont.files?.[0] || null, 'ScoreFont');
    fontCombo = await loadFontFromFile(el.comboFont.files?.[0] || null, 'ComboFont');
    setStatus('fonts ready');
  }

  function renderPreview(){
    const nW = Math.max(1, parseInt(el.nW.value||'44',10));
    const nH = Math.max(1, parseInt(el.nH.value||'66',10));
    const dotXExtraY = parseInt(el.dotXExtraY.value||'0',10);
    const centerBias = Math.max(0, Math.min(2, parseFloat(el.centerBias.value||'1')));

    const score = renderNormal({
      prefix: el.scorePrefix.value,
      family: fontScore,
      size: parseInt(el.scoreSize.value||'52',10),
      color: (el.scoreColor.value||'#fff').trim(),
      nW, nH,
      glyphs: SCORE_GLYPHS,
      keyForGlyph: scoreKeyForGlyph,
      dotXExtraY,
      centerBias
    });

    const combo = renderNormal({
      prefix: el.comboPrefix.value,
      family: fontCombo,
      size: parseInt(el.comboSize.value||'52',10),
      color: (el.comboColor.value||'#fff').trim(),
      nW, nH,
      glyphs: COMBO_GLYPHS,
      dotXExtraY,
      centerBias
    });

    fillPreview(el.pvScore, score.normal2x);
    fillPreview(el.pvCombo, combo.normal2x);

    const info = `${nW}√ó${nH}`;
    if(el.infoScore) el.infoScore.textContent = info;
    if(el.infoCombo) el.infoCombo.textContent = info;
    if(el.infoScore2) el.infoScore2.textContent = info;
    if(el.infoCombo2) el.infoCombo2.textContent = info;

    return {score, combo};
  }

  async function downloadArchives(){
    try{
      if(!window.JSZip){
        setStatus('JSZip missing (CDN blocked)');
        return;
      }

      await ensureFonts();
      setStatus('rendering');

      const nW = Math.max(1, parseInt(el.nW.value||'44',10));
      const nH = Math.max(1, parseInt(el.nH.value||'66',10));
      const dotXExtraY = parseInt(el.dotXExtraY.value||'0',10);
      const centerBias = Math.max(0, Math.min(2, parseFloat(el.centerBias.value||'1')));

      const score = renderNormal({
        prefix: el.scorePrefix.value,
        family: fontScore,
        size: parseInt(el.scoreSize.value||'52',10),
        color: (el.scoreColor.value||'#fff').trim(),
        nW, nH,
        glyphs: SCORE_GLYPHS,
        keyForGlyph: scoreKeyForGlyph,
        dotXExtraY,
        centerBias
      });

      const combo = renderNormal({
        prefix: el.comboPrefix.value,
        family: fontCombo,
        size: parseInt(el.comboSize.value||'52',10),
        color: (el.comboColor.value||'#fff').trim(),
        nW, nH,
        glyphs: COMBO_GLYPHS,
        dotXExtraY,
        centerBias
      });

      const entry = renderScoreEntry({
        prefix: el.scoreEntryPrefix.value,
        family: fontScore,
        size: parseInt(el.scoreEntrySize.value||'20',10),
        color: (el.scoreColor.value||'#fff').trim(),
        includeTransparentPercent: !!el.entryTransparentPercent.checked,
        transparentX: !!el.entryTransparentX.checked,
        dotXExtraY,
        centerBias
      });

      const zip = new JSZip();
      const normal = zip.folder('normal');

      const canvasToBlob = (c) => new Promise(res => c.toBlob(res,'image/png'));

      for(const [name, canvas] of score.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of score.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of combo.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of combo.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of entry.normal2x.entries()) normal.file(name, await canvasToBlob(canvas));
      for(const [name, canvas] of entry.normal1x.entries()) normal.file(name, await canvasToBlob(canvas));

      setStatus('zipping');

      const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'osu-archives.zip';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 2000);
      setStatus('done');
    }catch(e){
      console.error(e);
      setStatus('error (check console)');
    }
  }

  let debounceT = null;
  function schedulePreview(){
    clearTimeout(debounceT);
    debounceT = setTimeout(async () => {
      try{
        await ensureFonts();
        renderPreview();
        setStatus('preview updated');
      }catch(e){
        console.error(e);
        setStatus('error (check console)');
      }
    }, 140);
  }

  el.btnDownload.addEventListener('click', downloadArchives);

  const watch = [
    'scorePrefix','comboPrefix','scoreEntryPrefix',
    'scoreFont','comboFont',
    'nW','nH',
    'dotXExtraY','centerBias',
    'scoreSize','scoreColor',
    'comboSize','comboColor',
    'scoreEntrySize'
  ];
  watch.forEach(id => $(id).addEventListener('input', schedulePreview));
  $('scoreFont').addEventListener('change', schedulePreview);
  $('comboFont').addEventListener('change', schedulePreview);
  $('entryTransparentPercent').addEventListener('change', schedulePreview);
  $('entryTransparentX').addEventListener('change', schedulePreview);

  // extra "refresh" buttons from the new UI
  if(el.miniUpdateBtn) el.miniUpdateBtn.addEventListener('click', schedulePreview);
  if(el.forcePreviewBtn) el.forcePreviewBtn.addEventListener('click', schedulePreview);

  (async () => {
    try{
      await ensureFonts();
      renderPreview();
      setStatus('ready');
    }catch(e){
      setStatus('ready');
    }
  })();
})();
</script>
</body>
</html>
